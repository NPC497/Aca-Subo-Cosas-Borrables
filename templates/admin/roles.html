<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Roles</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/roles.css') }}">
</head>
<body>
  <!-- Header -->
  <header class="main-header-table">
      <div class="header-container">
          <button class="menu-toggle" id="menuToggle" aria-label="Toggle navigation menu">
              <span></span>
              <span></span>
              <span></span>
          </button>
          
        <!-- Logo -->
        <div class="logo">
            <img src="{{ url_for('static', filename='img/shared/logoabiertosinfondo.png') }}" width="60" alt="Logo">
        </div>
      </div>
  </header>

  <!-- Overlay para cuando el menú está abierto -->
  <div class="nav-overlay" id="navOverlay"></div>

  <!-- Navegación lateral -->
  <nav class="side-nav-table" id="side-nav-table">
      <div class="nav-content">
          <div class="nav-links-main">
                <a href="{{ url_for('index') }}" class="nav-link" data-name="inicio">
                  <i class='fas fa-home'></i>
                  <span>Inicio</span>
                </a>
                <a href="{{ url_for('roles') }}" class="nav-link active" data-name="roles">
                  <i class='fas fa-user-tag'></i>
                  <span>Roles</span>
                </a>
                <a href="{{ url_for('usuarios') }}" class="nav-link" data-name="usuarios">
                    <i class='fas fa-users'></i>
                    <span>Usuarios</span>
                </a>
                <a href="{{ url_for('usuarios_temporarios') }}" class="nav-link" data-name="usuarios-temporarios">
                    <i class='fas fa-user-clock'></i>
                    <span>Alta de Usuarios</span>
                </a>
                <a href="{{ url_for('puerta') }}" class="nav-link" data-name="puertas">
                    <i class='fas fa-door-open'></i>
                    <span>Puertas</span>
                </a>
                <a href="{{ url_for('permisos') }}" class="nav-link" data-name="permisos">
                    <i class='fas fa-key'></i>
                    <span>Permisos</span>
                </a>
                <a href="{{ url_for('actividad') }}" class="nav-link" data-name="actividad">
                    <i class='fas fa-chart-line'></i>
                    <span>Actividad</span>
                </a>
          </div>
      </div>
  </nav>

  <!-- Contenido principal -->
  <div class="container animate-box">
      <div class="abm-box">
          <h1 class="title-abm">Gestión de Roles</h1>
          <div class="search-container">
              <div class="input-box">
                  <i class="fas fa-search"></i>
                  <input type="text" id="searchInput" placeholder="Buscar rol por nombre...">
              </div>
              <button class="registro-btn" id="addNewRoleBtn">
                  <i class="fas fa-plus"></i> Crear Rol
              </button>
              <button class="registro-btn" id="assignExistingRoleBtn">
                  <i class="fas fa-user-plus"></i> Asignar Usuario
              </button>
          </div>
          
          <div class="table-container">
              <table class="users-table" id="rolesTable">
                  <thead>
                      <tr>
                          <th>Nombre del Rol <i class="fas fa-sort"></i></th>
                          <th>Acceso a Todas las Puertas</th>
                          <th>Asignar Permisos a Usuarios</th>
                          <th>Usuarios Asignados</th>
                          <th>Acciones</th>
                      </tr>
                  </thead>
                  <tbody>
                      <!-- Roles will be rendered here by JavaScript -->
                  </tbody>
              </table>
          </div>
          
          <div class="pagination">
              <button class="btn-page"><i class="fas fa-chevron-left"></i></button>
              <button class="btn-page active">1</button>
              <button class="btn-page">2</button>
              <button class="btn-page">3</button>
              <button class="btn-page"><i class="fas fa-chevron-right"></i></button>
          </div>
      </div>
  </div>

  <!-- Modal para confirmar eliminación de rol -->
  <div id="deleteRoleModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Confirmar Eliminación de Rol</h2>
              <span class="close" id="closeDeleteRoleModal">&times;</span>
          </div>
          <div class="modal-body">
              <p>¿Está seguro que desea eliminar este rol?</p>
              <p>Esta acción no se puede deshacer.</p>
              <p id="deleteRoleMessage" class="error-message" style="color: #e74c3c; margin-top: 10px;"></p>
          </div>
          <div class="modal-footer">
              <button class="btn-secondary" id="cancelDeleteRole">Cancelar</button>
              <button class="btn-danger" id="confirmDeleteRole">Eliminar</button>
          </div>
      </div>
  </div>

  <!-- Modal para registrar/editar rol -->
  <div id="roleFormModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="roleModalTitle">Registrar Rol</h2>
            <span class="close" id="closeRoleFormModal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="roleForm">
                <div class="form-group">
                    <label for="roleName">Nombre del Rol:</label>
                    <div class="input-box">
                        <i class="fas fa-user-tag"></i>
                        <input type="text" id="roleName" placeholder="Ingrese el nombre del rol" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="label-with-info">
                        Acceso a Todas las Puertas:
                        <i class="fas fa-info-circle info-icon" data-tooltip="Permite al rol acceder a todas las puertas del sistema sin restricciones"></i>
                    </label>
                    <div class="radio-group">
                        <div class="checkbox-group">
                            <input type="radio" id="accessAllDoorsYes" name="accessAllDoors" value="true">
                            <label for="accessAllDoorsYes">Sí</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="radio" id="accessAllDoorsNo" name="accessAllDoors" value="false" checked>
                            <label for="accessAllDoorsNo">No</label>
                        </div>
                    </div>
                </div>

                <!-- Door Access Selection (shown when "No" is selected) -->
                <div class="form-group" id="doorAccessGroup" style="display: block;">
                    <label>Seleccionar Puertas de Acceso:</label>
                    <div class="door-search-container">
                        <div class="input-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="doorSearchInput" placeholder="Buscar puerta por nombre o ubicación...">
                        </div>
                    </div>
                    <div id="doorSearchResults" class="door-search-results">
                        <!-- Door search results will be displayed here -->
                    </div>
                    <div id="selectedDoors" class="selected-doors">
                        <h4>Puertas Seleccionadas:</h4>
                        <div id="selectedDoorsList" class="selected-doors-list">
                            <!-- Selected doors will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="label-with-info">
                        Asignar Permisos a Usuarios:
                        <i class="fas fa-info-circle info-icon" data-tooltip="Permite al rol gestionar y asignar permisos a otros usuarios del sistema"></i>
                    </label>
                    <div class="radio-group">
                        <div class="checkbox-group">
                            <input type="radio" id="assignPermissionsToUsersYes" name="assignPermissionsToUsers" value="true">
                            <label for="assignPermissionsToUsersYes">Sí</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="radio" id="assignPermissionsToUsersNo" name="assignPermissionsToUsers" value="false" checked>
                            <label for="assignPermissionsToUsersNo">No</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="cancelRoleForm">Cancelar</button>
            <button class="btn-primary" id="saveRole">Guardar Rol</button>
        </div>
    </div>
</div>

  <!-- Modal para Asignar Rol a Usuario -->
  <div id="assignUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="assignUserModalTitle">Asignar Rol a Usuario</h2>
            <span class="close" id="closeAssignUserModal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="assignUserForm">
                <div class="form-group" id="existingRoleSelectGroup" style="display: none;">
                    <label for="roleSearchInput">Buscar Rol:</label>
                    <div class="input-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="roleSearchInput" placeholder="Escriba para buscar roles...">
                    </div>
                    <div id="roleSearchResults" class="user-search-results">
                        <!-- Role search results will be displayed here -->
                    </div>
                    <div id="selectedRoleDisplay" class="selected-role-display" style="display: none;">
                        <h4>Rol Seleccionado:</h4>
                        <div id="selectedRoleInfo" class="selected-role-info"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="userSearchInput">Buscar Usuario:</label>
                    <div class="input-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="userSearchInput" placeholder="DNI, Nombre, Apellido o Email">
                    </div>
                </div>
                <div id="userSearchResults" class="user-search-results">
                    <!-- Search results will be displayed here -->
                </div>
                <div id="assignUserMessage" class="message-container"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="cancelAssignUser">Cerrar</button>
        </div>
    </div>
</div>

  <!-- Modal para confirmar cambio de permisos de administrador -->
  <div id="adminPermissionChangeConfirmationModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Confirmar Cambio de Permisos</h2>
              <span class="close" id="closeAdminPermissionChangeConfirmationModal">&times;</span>
          </div>
          <div class="modal-body">
              <div class="warning-container">
                  <i class="fas fa-exclamation-triangle warning-icon"></i>
                  <div>
                      <p>Estás a punto de quitarle los permisos de administrador al rol <strong id="roleNameForAdminConfirm"></strong>.</p>
                      <p>Esto afectará a todos los usuarios asignados a este rol.</p>
                      <p><strong>¿Deseas continuar?</strong></p>
                  </div>
              </div>
          </div>
          <div class="modal-footer">
              <button class="btn-secondary" id="cancelAdminPermissionChange">Cancelar</button>
              <button class="btn-danger" id="confirmAdminPermissionChange">Continuar</button>
          </div>
      </div>
  </div>

  <!-- Modal para Reasignar o Quitar Roles a Usuarios Afectados -->
  <div id="reassignOrRemoveUsersModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Rol Asignado a Usuarios</h2>
              <span class="close" id="closeReassignOrRemoveUsersModal">&times;</span>
          </div>
          <div class="modal-body">
              <div class="warning-container">
                  <i class="fas fa-users warning-icon"></i>
                  <div>
                      <p>El rol "<strong id="roleNameForReassign"></strong>" está asignado a los siguientes usuarios:</p>
                  </div>
              </div>
              <ul id="affectedUsersList" class="affected-users-list">
                  <!-- Users will be listed here -->
              </ul>
              <p class="mt-4"><strong>¿Qué deseas hacer con estos usuarios?</strong></p>
              <div class="form-group mt-2">
                  <label for="newRoleForAffectedUsers">Asignar un nuevo rol:</label>
                  <select id="newRoleForAffectedUsers" class="form-control">
                      <option value="">-- Seleccionar --</option>
                      <!-- Roles will be populated by JS -->
                  </select>
              </div>
          </div>
          <div class="modal-footer">
              <button class="btn-secondary" id="cancelReassignOrRemoveUsers">Cancelar</button>
              <button class="btn-danger" id="removeRoleFromAllAffected">Quitar Rol</button>
              <button class="btn-primary" id="reassignRoleToAffected">Reasignar Rol</button>
          </div>
      </div>
  </div>

  <!-- Modal de confirmación personalizada -->
  <div id="confirmationModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2 id="confirmationTitle">Confirmar Acción</h2>
              <span class="close" id="closeConfirmationModal">&times;</span>
          </div>
          <div class="modal-body">
              <div class="warning-container">
                  <i id="confirmationIcon" class="fas fa-question-circle warning-icon"></i>
                  <div>
                      <p id="confirmationMessage">¿Está seguro de realizar esta acción?</p>
                  </div>
              </div>
          </div>
          <div class="modal-footer">
              <button class="btn-secondary" id="cancelConfirmation">Cancelar</button>
              <button class="btn-primary" id="acceptConfirmation">Aceptar</button>
          </div>
      </div>
  </div>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip"></div>

  <script src="{{ url_for('static', filename='js/admin/roles.js') }}"></script>
</body>
</html>
